# RAG POC Architecture - Backend Engineering Showcase

## Overview

This RAG (Retrieval-Augmented Generation) POC demonstrates advanced backend engineering skills beyond simple AI API calls. It features:

- **Session-based in-memory storage** (no database costs)
- **Multiple RAG strategies** (algorithmic depth)
- **Parallel processing pipelines** (performance optimization)
- **SIMD-accelerated vector operations** (low-level optimization)
- **Comprehensive caching** (embedding deduplication)
- **Rate limiting & cancellation** (production-ready patterns)

## Architecture Layers

```
???????????????????????????????????????????????????????????????
?                    Blazor UI Components                      ?
?  ???????????????  ???????????????  ????????????????????    ?
?  ? DocUploader ?  ? QueryInput  ?  ? CitationDisplay  ?    ?
?  ???????????????  ???????????????  ????????????????????    ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?                    API Endpoints (SSE)                       ?
?  POST /api/rag/session  POST /api/rag/ingest                ?
?  POST /api/rag/query    GET /api/rag/stats                  ?
???????????????????????????????????????????????????????????????
                              ?
                              ?
???????????????????????????????????????????????????????????????
?                    RAG Orchestrator                          ?
?  ???????????????????????????????????????????????????????   ?
?  ?  Coordinates: Ingest ? Store ? Retrieve ? Generate   ?   ?
?  ?  Handles: Cancellation, Progress, Metrics            ?   ?
?  ???????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
                              ?
          ?????????????????????????????????????????
          ?                   ?                   ?
??????????????????? ??????????????????? ???????????????????
? Document        ? ? Embedding       ? ? Query           ?
? Pipeline        ? ? Service         ? ? Strategies      ?
?                 ? ?                 ? ?                 ?
? • Chunking      ? ? • Gemini API    ? ? • NaiveRAG      ?
? • Parallel      ? ? • Caching       ? ? • SemanticRAG   ?
? • Channel<T>    ? ? • Rate Limit    ? ? • HyDERAG       ?
??????????????????? ??????????????????? ???????????????????
          ?                   ?                   ?
          ?????????????????????????????????????????
                              ?
???????????????????????????????????????????????????????????????
?                    Session Vector Store                      ?
?  ???????????????????????????????????????????????????????   ?
?  ?  • IMemoryCache-backed sessions (TTL: 15 min)        ?   ?
?  ?  • SIMD cosine similarity (Vector<float>)            ?   ?
?  ?  • Top-K retrieval with relevance scoring            ?   ?
?  ???????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????????
```

## Backend Skills Demonstrated

### 1. Parallel Processing (`Task.WhenAll`, `Parallel.ForEachAsync`)
```csharp
// Parallel chunk embedding
var embeddingTasks = chunks.Select(chunk => 
    EmbedWithCacheAsync(chunk, cancellationToken));
var embeddings = await Task.WhenAll(embeddingTasks);
```

### 2. Producer-Consumer Pattern (`Channel<T>`)
```csharp
// Document processing pipeline
var channel = Channel.CreateBounded<ChunkResult>(options);
var producer = ProduceChunksAsync(document, channel.Writer);
var consumer = ConsumeAndEmbedAsync(channel.Reader);
await Task.WhenAll(producer, consumer);
```

### 3. SIMD-Accelerated Vector Operations
```csharp
// Hardware-accelerated cosine similarity
public static float CosineSimilarity(ReadOnlySpan<float> a, ReadOnlySpan<float> b)
{
    var vecA = new Vector<float>(a);
    var vecB = new Vector<float>(b);
    // SIMD dot product in single instruction
}
```

### 4. Caching & Rate Limiting
```csharp
// Embedding cache to avoid redundant API calls
private readonly IMemoryCache _embeddingCache;
private readonly SemaphoreSlim _rateLimiter = new(maxConcurrent: 5);
```

### 5. Cancellation & Timeout Handling
```csharp
// Full cancellation propagation
await ProcessAsync(data, cancellationToken);
using var cts = CancellationTokenSource.CreateLinkedTokenSource(ct);
cts.CancelAfter(TimeSpan.FromSeconds(30));
```

## RAG Strategies

### 1. NaiveRAG (Baseline)
Simple direct similarity search:
1. Embed query
2. Find top-K similar chunks
3. Generate answer with context

### 2. SemanticRAG (Enhanced)
Query expansion and reranking:
1. Expand query with synonyms/related terms
2. Multi-query retrieval
3. Rerank results by relevance
4. Generate answer with refined context

### 3. HyDERAG (Advanced)
Hypothetical Document Embeddings:
1. Generate hypothetical answer (without context)
2. Embed the hypothetical answer
3. Search using hypothetical embedding
4. Generate final answer with retrieved context

## Session Management

```csharp
public class RAGSession
{
    public string SessionId { get; init; }
    public DateTime CreatedAt { get; init; }
    public DateTime ExpiresAt { get; init; }
    public List<DocumentInfo> Documents { get; } = new();
    public List<ChunkWithEmbedding> Chunks { get; } = new();
    public RAGMetrics Metrics { get; } = new();
}
```

Sessions are stored in `IMemoryCache` with:
- **TTL**: 15 minutes (configurable)
- **Sliding expiration**: Resets on each access
- **Max documents**: 2 (demo limit, configurable)
- **Max file size**: 50KB (demo limit, configurable)

## Performance Metrics

Every operation tracks:
- **Chunking time** (ms)
- **Embedding time** (ms) 
- **Retrieval time** (ms)
- **Generation time** (ms)
- **Total tokens used**
- **Cache hits/misses**
- **Memory usage** (bytes)

Metrics are exposed in response headers and `/api/rag/stats` endpoint.

## Demo vs Full Capability

| Feature | Demo (Deployed) | Full (Code) |
|---------|-----------------|-------------|
| Documents per session | 2 | Unlimited |
| File size | 50KB | Configurable |
| All RAG strategies | ? Visible | ? Working |
| Parallel processing | ? Active | ? Active |
| SIMD optimization | ? Active | ? Active |
| Metrics display | ? Full | ? Full |
